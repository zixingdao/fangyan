# 长沙方言采集平台 - 重构与迁移指南 (Refactoring Guide)

本文档详细记录了将原有的 Express + Vue 项目重构为 **React + NestJS Monorepo** 架构的完整过程、设计决策以及迁移步骤。

---

## 一、 重构背景与目标

### 1.1 背景
原项目 (`老代码/`) 采用 Express (后端) + Vue 3 (前端) 的传统分离架构。为了更好地支持 AI 辅助编程、提升前后端协作效率以及适应未来的扩展需求（如音频处理、多端复用），决定进行全面重构。

### 1.2 核心目标
1.  **AI 友好 (AI-First)**: 通过 Monorepo 和 Schema-First 策略，让 AI 能准确理解跨端类型和上下文，减少幻觉。
2.  **类型安全 (Type Safety)**: 引入 TypeScript 全栈开发，利用 Shared 包实现前后端类型共享。
3.  **架构升级**:
    - 前端：迁移至 React 生态 (React 18 + Vite + AntD/Tailwind)。
    - 后端：升级为 NestJS (企业级模块化框架)。
    - 部署：采用集成部署模式，简化运维。

---

## 二、 新架构概览

采用 **pnpm workspace** 管理的 Monorepo 结构：

```text
长沙方言软件/
├── packages/                 # [共享层]
│   ├── shared/               # 核心契约库 (Zod Schema -> TS Types)
│   └── ui/                   # 通用 UI 组件库 (React)
├── apps/                     # [应用层]
│   ├── client/               # 用户端 (React)
│   ├── admin/                # 管理端 (React)
│   └── server/               # 后端 (NestJS)
└── database/                 # 数据库脚本
```

---

## 三、 详细重构步骤

### 3.1 第一步：Monorepo 骨架搭建 (已完成)

1.  **初始化工作区**:
    - 创建 `pnpm-workspace.yaml`，定义 `packages/*` 和 `apps/*` 为工作区。
    - 配置根目录 `package.json`，支持 `pnpm -r` 批量命令。

2.  **创建共享包 (packages/shared)**:
    - 引入 `zod` 作为核心依赖。
    - 建立了 Schema 定义规范：`src/schemas` (Zod) -> `src/types` (Infer)。
    - **目的**: 解决前后端接口字段不一致的问题，作为唯一的“真理来源”。

3.  **创建 UI 包 (packages/ui)**:
    - 引入 `react` 和 `antd`。
    - 封装基础组件（如 Button）。
    - **目的**: 统一用户端和管理端的视觉风格，减少重复代码。

### 3.2 第二步：应用层初始化 (已完成)

1.  **前端应用 (Client & Admin)**:
    - 使用 Vite 初始化 React + TS 项目。
    - 配置 `vite.config.ts` 路径别名 (`@/`)。
    - 在 `package.json` 中链接共享包：`"@changsha/shared": "workspace:*"`。

2.  **后端应用 (Server)**:
    - 使用 NestJS CLI 规范初始化。
    - 配置 `nest-cli.json`。
    - 引入 `@changsha/shared` 依赖，准备接管 API 定义。

### 3.3 第三步：数据库迁移 (进行中)

- **现状**: 原项目使用 `init.sql` 初始化 MySQL。
- **迁移**: 将 `老代码/database/init.sql` 复制到新架构 `database/init.sql`。
- **下一步**: 在 NestJS 中配置 TypeORM，基于现有的表结构生成实体 (Entity)。

---

## 四、 后续迁移计划 (Migration Roadmap)

### 阶段一：基础设施完善 (Infrastructure)
- [ ] **依赖安装**: 执行 `pnpm install` 安装所有依赖。
- [ ] **数据库连接**: 在 `apps/server` 中配置 TypeORM 连接 MySQL。
- [ ] **全局异常处理**: 在 NestJS 中引入 `ZodValidationPipe` 和全局异常过滤器。

### 阶段二：核心业务迁移 (Core Features)
遵循 **Schema-First** 流程进行迁移：

1.  **用户认证 (Auth)**:
    - 在 `shared` 定义 `LoginSchema`。
    - 后端实现 `AuthModule` (JWT策略)。
    - 前端 `client` 和 `admin` 实现登录页面，对接 API。

2.  **文件上传 (Upload)**:
    - 迁移原 Express 的 `multer` 逻辑到 NestJS。
    - 确认 OSS 配置。

3.  **业务功能**:
    - 迁移“录制记录”和“榜单”逻辑。

### 阶段三：清理与交付
- [ ] 移除 `老代码` 目录。
- [ ] 编写详细的 API 文档（或集成 Swagger）。
- [ ] 进行集成测试。

---

## 五、 开发规范 (针对 AI 辅助)

在后续开发中，请严格遵守以下规则以获得最佳 AI 辅助体验：

1.  **修改逻辑前**: 先检查 `packages/shared`，看是否需要修改 Schema。
2.  **修改 UI 前**: 先检查 `packages/ui`，看是否有可复用的组件。
3.  **保持上下文**: 修改某个功能时，尽量只关注对应的 `features/` 目录。

---

**文档维护人**: AI Pair Programmer
**最后更新**: 2026-02-10
